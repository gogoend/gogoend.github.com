<!DOCTYPE HTML>
<html style="font-size:100px">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <script src="../lib/three.js"></script>
    <script src="../lib/vue.js"></script>
    <script src="../control_stick/util.js"></script>
    <script src="../control_stick/stick.js"></script>
    <style>
        html,
        body,
        #app {
            padding: 0;
            margin: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
        }

        body {
            font-family: sans-serif;
            line-height: 1em;
            font-size: 0.16rem;
        }

        button {
            font-size: 0.16rem;
            font-family: sans-serif;
        }

        div {
            box-sizing: border-box;
        }

        ul,
        li {
            list-style: none;
            margin: 0;
            padding: 0
        }

        p {
            margin: 0;
        }

        #app {
            position: relative;
        }

        .panoControls {
            position: absolute;
            display: flex;
            justify-content: flex-end;
            width: 100%;
            align-items: center;
            top: -0.64rem;
            padding: 0 0.2rem;
        }

        .panoControls>button,
        .panoControls>div,
        .panoControls>a,
        .panoControls>input {
            pointer-events: all;
        }

        .panoControls button.fullScreenBtn {
            border: #62d128 solid 2px;
            background: #1c1c1c;
            color: #62d128;
            padding: 0.1rem 0.2rem;
            display: block
        }

        .panoPanelBottom {
            position: absolute;
            height: 1.6rem;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            bottom: 0;
            transition: 0.4s ease bottom
        }

        .panoPanelBottom.fold {
            bottom: -1.6rem;
        }


        .panoList {
            width: 100%;
            height: 100%;
            display: flex;
            overflow-x: auto;
        }

        .panoList>ul {
            display: flex;
            color: #fff;
            margin: 0 auto;
        }

        .panoList>ul li {
            display: flex;
            flex-direction: column;
            color: #fff;
            justify-content: center;
            margin: 0 10px;
        }

        .panoList>ul li>img.panoThumb {
            width: 2rem;
        }

        .panoList>ul li>p.panoTitle {
            line-height: 1.5em;
            text-align: center;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="panoPanelBottom">
            <div class="panoList">
                <ul>
                    <li v-for="(pano,index) in panos">
                            <img class="panoThumb" @click="panoTexChange(index)" :src="panoThumbPath+pano.imgThumb" />
                            <p class="panoTitle">{{pano.desc}}</p>
                    </li>

                    <!-- <li>
                        <img class="panoThumb" src="./pano_thumb/thumb.jpg" />
                        <p class="panoTitle">Hola</p>
                    </li>
                    <li>
                        <img class="panoThumb" src="./pano_thumb/thumb.jpg" />
                        <p class="panoTitle">Hola</p>
                    </li>
                    <li>
                        <img class="panoThumb" src="./pano_thumb/thumb.jpg" />
                        <p class="panoTitle">Hola</p>
                    </li>
                    <li>
                        <img class="panoThumb" src="./pano_thumb/thumb.jpg" />
                        <p class="panoTitle">Hola</p>
                    </li> -->
                </ul>
            </div>

            <div class="panoControls">

                <!-- <button onclick="fullScreen" class="fullScreenBtn">全屏</button> -->

                <button v-if="!fullScreenStatus" v-on:click="fullScreen" class="fullScreenBtn">全屏</button>
                <button v-else v-on:click="fullScreen" class="fullScreenBtn">退出全屏</button>

            </div>
        </div>
    </div>


    <script src="./pano_array.js"></script>
    <script>



        //rem
        (function (doc, win) {
            var docEl = doc.documentElement,
                resizeEvt = 'orientationchange' in window ? 'orientationchange' : 'resize',
                recalc = function () {
                    var clientWidth = docEl.clientWidth;
                    if (!clientWidth) return;
                    if (clientWidth >= 750) {
                        docEl.style.fontSize = '100px';
                    } else {
                        docEl.style.fontSize = 100 * (clientWidth / 750) + 'px';
                    }
                };

            if (!doc.addEventListener) return;
            win.addEventListener(resizeEvt, recalc, false);
            doc.addEventListener('DOMContentLoaded', recalc, false);
        })(document, window);


        //配置全景图文件夹基地址
        var panoBasePath = "./pano_images/",
            panoThumbPath = "./pano_thumb/";

                    //请求全屏
        // var fullScreenStatus = false;
        // function fullScreen() {
        //     if (!fullScreenStatus) {
        //         document.body.requestFullscreen();
        //         fullScreenStatus = true
        //     } else {
        //         document.exitFullscreen();
        //         fullScreenStatus = false
        //     }
        // }

        var panoApp = new Vue({
            el: '#app',
            data: {
                fullScreenStatus: false,

                panos:panos,
                currentIndex:1,

                //配置全景图文件夹基地址
                panoBasePath : panoBasePath,
                panoThumbPath : panoThumbPath
            },
            methods: {
                fullScreen: function () {
                    if (!this.fullScreenStatus) {
                        document.body.requestFullscreen();
                        this.fullScreenStatus = true
                    } else {
                        document.exitFullscreen();
                        this.fullScreenStatus = false
                    }
                },
                panoTexChange:function(listNum){
                    panoImgTex.needsUpdate=true;
                    panoImgTex.image.src=panoBasePath+panos[listNum].imgName;
                    panoImgTex.needsUpdate=false;
                }
            }
        });

        //THREEJS场景部分
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        var renderer = new THREE.WebGLRenderer({
            "antialias": true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('app').appendChild(renderer.domElement);

        var panoGeometry = new THREE.SphereGeometry(1, 36, 36);
        //直接将x设为-1，使得所有面朝向内测
        panoGeometry.scale(-1, 1, 1);


        var panoImgTex = new THREE.TextureLoader().load(panoBasePath + panos[4].imgName);


        panoImgTex.anisotropy = 8;

        var panoPhotoMaterial = new THREE.MeshStandardMaterial({
            "map": panoImgTex,
            "color": 0xffffff,
        });
        var panoSphere = new THREE.Mesh(panoGeometry, panoPhotoMaterial);
        scene.add(panoSphere);

        var light = new THREE.AmbientLight(0xffffff, 2);
        scene.add(light);

        var g = new THREE.Group();
        g.add(camera);
        scene.add(g);

        //摄像机目标
        var cameraTargetMesh = new THREE.BoxBufferGeometry(0.2, 0.2, 0.2);
        var cameraTargetMaterial = new THREE.MeshBasicMaterial({
            color: 0x00ffff
        })
        var cameraTarget = new THREE.Mesh(cameraTargetMesh, cameraTargetMaterial);
        cameraTarget.name = "cameraTarget";

        /*交互方式：
        改变全景照片的方向
            鼠标/触摸：在屏幕上上下滑动改变上下旋转角，左右滑动更改平面旋转角；
            设备朝向：移动设备改变摄像机目标的位置
        改变摄像机的FOV
            鼠标滚轮：向前放大，向后缩小
        */
        var lookAroundDeg = 0;

        //第一个值为半径，第二个值为上下旋转角，第三个值为平面极坐标的旋转角
        var sphereCood = new THREE.Spherical(10, util.degToRad(225), 0);
        cameraTarget.position.setFromSpherical(sphereCood);

        scene.add(cameraTarget);

        //交互部分
        //判断是否存在用户交互
        var userInteract = false;
        function animate() {

            if (!userInteract) {
                sphereCood.theta += util.degToRad(0.1);
                cameraTarget.position.setFromSpherical(sphereCood);
                camera.lookAt(cameraTarget.position);
            }

            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        // setInterval(animate,100);
        animate();

        window.onresize = function () {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
        }

        // document.addEventListener("deviceorientation",function(e){
        //     console.log(e)
        // },false)

        var mouseData = {
            originX: 0,
            originY: 0,
            offsetX: 0,
            offsetY: 0,
            originTheta: 0,
            originPhi: 0
        }
        function pointHandler(e) {
            var evtType = e.type;
            e.preventDefault();
            if (e.type.match('touch')) {
                console.log('触摸事件');
                e = e.touches[0];
            }
            switch (evtType) {
                case "touchstart":
                case "mousedown": {
                    userInteract = true;
                    //得到鼠标点击位置
                    mouseData.originX = e.clientX;
                    mouseData.originY = e.clientY;

                    //
                    mouseData.originTheta = sphereCood.theta;
                    mouseData.originPhi = sphereCood.phi;
                    //

                    document.addEventListener("mousemove", pointHandler, false);
                    document.addEventListener("mouseup", pointHandler, false);

                    document.addEventListener("touchmove", pointHandler, false);
                    document.addEventListener("touchend", pointHandler, false);

                    break;
                }
                case "touchmove":
                case "mousemove": {
                    if (userInteract) {

                        //鼠标移动时计算鼠标的偏移量
                        mouseData.offsetX = e.clientX - mouseData.originX;
                        mouseData.offsetY = e.clientY - mouseData.originY;
                        console.log(mouseData);

                        //
                        sphereCood.theta = mouseData.offsetX * 0.005 + mouseData.originTheta;
                        console.log(util.radToDeg(sphereCood.phi))

                        var phi = mouseData.offsetY * 0.005 + mouseData.originPhi;
                        //限制上下俯仰角度，以防万向锁。来自THREEJS
                        sphereCood.phi = util.clamp(phi, util.degToRad(181), util.degToRad(359))

                        console.log(sphereCood.theta + ' ' + sphereCood.phi)

                        cameraTarget.position.setFromSpherical(sphereCood);
                        camera.lookAt(cameraTarget.position);

                    }
                    break;
                }

                case "touchend":
                case "mouseup": {
                    userInteract = false;

                    document.removeEventListener("mouseup", pointHandler, false);
                    document.removeEventListener("touchend", pointHandler, false);

                    document.removeEventListener("mousemove", pointHandler, false);
                    document.removeEventListener("touchmove", pointHandler, false);


                    break;
                }
            }

        }

        function mouseScrollHandler(e) {
            console.log(e)
        }

        document.addEventListener('touchstart', pointHandler, false);
        document.addEventListener("mousedown", pointHandler, false);
        document.addEventListener("mousewheel", mouseScrollHandler, false);



        //页面管理
        var hash = location.hash;
        // console.log(hash);
        window.addEventListener("hashchange", function (e) {
            console.log(e);
        }, false);








    </script>
</body>

</html>